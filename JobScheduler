import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import java.io.IOException;
import java.io.OutputStream;
import java.util.Map;

@WebServlet("/DownloadExcelServlet")
public class DownloadExcelServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Retrieve data from session
        HttpSession session = request.getSession();
        Map<String, String[]> dataValues = (Map<String, String[]>) session.getAttribute("dataValues");

        if (dataValues == null || dataValues.isEmpty()) {
            response.getWriter().write("No data available to download.");
            return;
        }

        // Create Excel workbook and sheet
        Workbook workbook = new XSSFWorkbook();
        Sheet sheet = workbook.createSheet("Data");

        // Create header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"S.NO", "Active Directory", "Manager Name", "Created Date"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
        }

        // Populate data rows
        int rowIndex = 1;
        int sno = 1; // Serial number
        for (Map.Entry<String, String[]> entry : dataValues.entrySet()) {
            Row row = sheet.createRow(rowIndex++);
            String sys = entry.getKey();
            String[] values = entry.getValue();

            row.createCell(0).setCellValue(sno++); // S.NO
            row.createCell(1).setCellValue(sys);   // Active Directory
            row.createCell(2).setCellValue(values[0]); // Manager Name
            row.createCell(3).setCellValue(values[1]); // Created Date
        }

        // Set response headers
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setHeader("Content-Disposition", "attachment; filename=data.xlsx");

        // Write workbook to response output stream
        try (OutputStream outputStream = response.getOutputStream()) {
            workbook.write(outputStream);
        }

        workbook.close();
    }
}
